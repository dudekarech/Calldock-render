<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallDocker - Enterprise Call Center Solution</title>
    <meta name="description" content="Modern, scalable call center solution with WebRTC, IVR, and intelligent routing. Deploy in minutes with Docker.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-primary-600">
                            <i class="fas fa-phone-alt mr-2"></i>CallDocker
                        </h1>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#features" class="text-gray-700 hover:text-primary-600 transition">Features</a>
                    <a href="#pricing" class="text-gray-700 hover:text-primary-600 transition">Pricing</a>
                    <a href="#demo" class="text-gray-700 hover:text-primary-600 transition">Demo</a>
                    <a href="#contact" class="text-gray-700 hover:text-primary-600 transition">Contact</a>
                    <button onclick="openSignupModal()" class="bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition">
                        Get Started
                    </button>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-gray-700">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#features" class="block px-3 py-2 text-gray-700 hover:text-primary-600">Features</a>
                <a href="#pricing" class="block px-3 py-2 text-gray-700 hover:text-primary-600">Pricing</a>
                <a href="#demo" class="block px-3 py-2 text-gray-700 hover:text-primary-600">Demo</a>
                <a href="#contact" class="block px-3 py-2 text-gray-700 hover:text-primary-600">Contact</a>
                <button onclick="openSignupModal()" class="w-full mt-2 bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700">
                    Get Started
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-gradient text-white pt-24 pb-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div class="space-y-8">
                    <h1 class="text-5xl lg:text-6xl font-bold leading-tight">
                        Modern Call Center
                        <span class="block text-blue-200">Made Simple</span>
                    </h1>
                    <p class="text-xl text-blue-100 leading-relaxed">
                        Deploy a complete call center solution in minutes with Docker. 
                        WebRTC-powered, scalable, and enterprise-ready.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="openSignupModal()" class="bg-white text-primary-600 px-8 py-4 rounded-lg font-semibold hover:bg-gray-100 transition text-lg">
                            Start Free Trial
                        </button>
                        <button onclick="scrollToDemo()" class="border-2 border-white text-white px-8 py-4 rounded-lg font-semibold hover:bg-white hover:text-primary-600 transition text-lg">
                            Watch Demo
                        </button>
                    </div>
                    <div class="flex items-center space-x-6 text-blue-200">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>No setup fees</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>14-day free trial</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>Cancel anytime</span>
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 animate-float">
                        <div class="bg-white rounded-lg p-6 shadow-xl">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <span class="text-sm text-gray-500">CallDocker Dashboard</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-phone text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-800">Active Call</div>
                                            <div class="text-sm text-gray-600">+1 (555) 123-4567</div>
                                        </div>
                                    </div>
                                    <div class="text-green-600 font-semibold">02:34</div>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-800">Agent Available</div>
                                            <div class="text-sm text-gray-600">Sarah Johnson</div>
                                        </div>
                                    </div>
                                    <div class="text-blue-600">
                                        <i class="fas fa-circle text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">
                    Everything You Need for Modern Customer Support
                </h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    From WebRTC calls to intelligent routing, CallDocker provides all the tools 
                    your team needs to deliver exceptional customer experiences.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- WebRTC Calls -->
                <div class="feature-card bg-white p-8 rounded-xl shadow-lg border border-gray-100 transition-all duration-300">
                    <div class="w-16 h-16 bg-primary-100 rounded-lg flex items-center justify-center mb-6">
                        <i class="fas fa-phone-alt text-primary-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">WebRTC Calls</h3>
                    <p class="text-gray-600 mb-4">
                        Crystal-clear voice calls powered by WebRTC technology. 
                        No plugins required, works in any modern browser.
                    </p>
                    <ul class="text-sm text-gray-500 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>HD audio quality</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Browser-native</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Low latency</li>
                    </ul>
                </div>

                <!-- Intelligent Routing -->
                <div class="feature-card bg-white p-8 rounded-xl shadow-lg border border-gray-100 transition-all duration-300">
                    <div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center mb-6">
                        <i class="fas fa-route text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Smart Routing</h3>
                    <p class="text-gray-600 mb-4">
                        Intelligent call routing based on agent skills, availability, 
                        and customer preferences.
                    </p>
                    <ul class="text-sm text-gray-500 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Skill-based routing</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Load balancing</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Priority queuing</li>
                    </ul>
                </div>

                <!-- IVR System -->
                <div class="feature-card bg-white p-8 rounded-xl shadow-lg border border-gray-100 transition-all duration-300">
                    <div class="w-16 h-16 bg-purple-100 rounded-lg flex items-center justify-center mb-6">
                        <i class="fas fa-microphone text-purple-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">IVR System</h3>
                    <p class="text-gray-600 mb-4">
                        Custom interactive voice response system with visual flow builder 
                        and text-to-speech integration.
                    </p>
                    <ul class="text-sm text-gray-500 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Visual flow builder</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Text-to-speech</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Multi-language support</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Demo Section -->
    <section id="demo" class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">
                    See CallDocker in Action
                </h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Watch how easy it is to set up and use CallDocker for your call center needs.
                </p>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="aspect-video bg-gray-900 rounded-lg flex items-center justify-center">
                    <div class="text-center text-white">
                        <i class="fas fa-play-circle text-6xl mb-4 text-primary-500"></i>
                        <h3 class="text-2xl font-semibold mb-2">CallDocker Demo</h3>
                        <p class="text-gray-300">Watch our comprehensive demo video</p>
                        <button class="mt-4 bg-primary-600 text-white px-8 py-3 rounded-lg hover:bg-primary-700 transition">
                            Play Demo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">
                    Simple, Transparent Pricing
                </h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Choose the plan that fits your needs. All plans include our core features.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Starter Plan -->
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-primary-500 transition-all duration-300">
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Starter</h3>
                        <div class="text-4xl font-bold text-gray-900 mb-2">$29</div>
                        <div class="text-gray-600">per month</div>
                    </div>
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Up to 5 agents</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>1,000 minutes/month</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Basic IVR</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Email support</span>
                        </li>
                    </ul>
                    <button onclick="openSignupModal()" class="w-full bg-gray-100 text-gray-900 py-3 rounded-lg font-semibold hover:bg-gray-200 transition">
                        Get Started
                    </button>
                </div>

                <!-- Professional Plan -->
                <div class="bg-white border-2 border-primary-500 rounded-2xl p-8 relative">
                    <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                        <span class="bg-primary-500 text-white px-4 py-1 rounded-full text-sm font-semibold">Most Popular</span>
                    </div>
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Professional</h3>
                        <div class="text-4xl font-bold text-gray-900 mb-2">$99</div>
                        <div class="text-gray-600">per month</div>
                    </div>
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Up to 25 agents</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>10,000 minutes/month</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Advanced IVR</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Priority support</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Analytics dashboard</span>
                        </li>
                    </ul>
                    <button onclick="openSignupModal()" class="w-full bg-primary-500 text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition">
                        Get Started
                    </button>
                </div>

                <!-- Enterprise Plan -->
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-primary-500 transition-all duration-300">
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Enterprise</h3>
                        <div class="text-4xl font-bold text-gray-900 mb-2">$299</div>
                        <div class="text-gray-600">per month</div>
                    </div>
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Unlimited agents</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Unlimited minutes</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Custom IVR flows</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>24/7 support</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Custom integrations</span>
                        </li>
                    </ul>
                    <button onclick="openSignupModal()" class="w-full bg-gray-100 text-gray-900 py-3 rounded-lg font-semibold hover:bg-gray-200 transition">
                        Contact Sales
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">
                    Ready to Get Started?
                </h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Join thousands of companies using CallDocker to transform their customer support.
                </p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <div>
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Get in Touch</h3>
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-envelope text-primary-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Email</div>
                                <div class="text-gray-600">support@calldocker.com</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-phone text-green-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Phone</div>
                                <div class="text-gray-600">+1 (555) 123-4567</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-2xl p-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Start Your Free Trial</h3>
                    <form class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-primary-600 text-white py-3 rounded-lg font-semibold hover:bg-primary-700 transition">
                            Start Free Trial
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4">
                    <i class="fas fa-phone-alt mr-2"></i>CallDocker
                </h3>
                <p class="text-gray-400 mb-4">
                    Modern call center solution for the digital age.
                </p>
                <div class="flex justify-center space-x-4 mb-6">
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-linkedin text-xl"></i>
                    </a>
                    <a href="#" class="fab fa-github text-xl text-gray-400 hover:text-white transition"></a>
                </div>
                <div class="border-t border-gray-800 pt-6 text-gray-400">
                    <p>&copy; 2024 CallDocker. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Signup Modal -->
    <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">Get Started</h3>
                    <button onclick="closeSignupModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                        <input type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-primary-600 text-white py-3 rounded-lg font-semibold hover:bg-primary-700 transition">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Floating Call Widget -->
    <div id="floatingCallWidget" class="fixed bottom-6 right-6 z-50 hidden">
        <!-- Mini Widget (Collapsed State) -->
        <div id="miniWidget" class="bg-white rounded-lg shadow-xl border border-gray-200 p-3 cursor-move">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-phone text-white text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-gray-900 truncate" id="miniCallerName">Agent</div>
                    <div class="text-xs text-gray-500" id="miniCallTimer">00:00</div>
                </div>
                <div class="flex items-center space-x-1">
                    <button id="expandWidgetBtn" class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fas fa-expand-arrows-alt text-xs"></i>
                    </button>
                    <button id="endCallMiniBtn" class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-phone-slash text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Expanded Widget (Full State) -->
        <div id="expandedWidget" class="bg-white rounded-lg shadow-xl border border-gray-200 w-80 hidden">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 cursor-move" id="widgetHeader">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-phone text-white"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-900" id="expandedCallerName">Agent</div>
                        <div class="text-sm text-gray-500" id="expandedCallTimer">00:00</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="minimizeWidgetBtn" class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fas fa-compress-arrows-alt text-sm"></i>
                    </button>
                    <button id="closeWidgetBtn" class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Video Area -->
            <div id="widgetVideoArea" class="p-4 space-y-3">
                <!-- Local Video Preview -->
                <div id="widgetLocalVideoContainer" class="hidden">
                    <p class="text-xs text-gray-500 mb-1">Your camera</p>
                    <video id="widgetLocalVideo" class="w-full h-24 object-cover rounded-lg border border-gray-300" muted autoplay playsinline></video>
                </div>
                
                <!-- Remote Video Display -->
                <div id="widgetRemoteVideoContainer" class="hidden">
                    <p class="text-xs text-gray-500 mb-1">Agent</p>
                    <video id="widgetRemoteVideo" class="w-full h-32 object-cover rounded-lg border border-gray-300" autoplay playsinline></video>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex justify-center space-x-3">
                    <button id="widgetMuteBtn" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-microphone text-gray-600 text-sm"></i>
                    </button>
                    <button id="widgetVideoBtn" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors hidden">
                        <i class="fas fa-video text-gray-600 text-sm"></i>
                    </button>
                    <button id="widgetScreenShareBtn" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors hidden">
                        <i class="fas fa-desktop text-gray-600 text-sm"></i>
                    </button>
                    <button id="widgetEndCallBtn" class="w-10 h-10 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-phone-slash text-white text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Original Call Widget -->
    <div id="callWidget" class="fixed bottom-6 right-6 z-40">
        <!-- Call Button -->
        <button id="callButton" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition-all duration-300 transform hover:scale-110">
            <i class="fas fa-phone text-2xl"></i>
        </button>
        
        <!-- Call Interface (Hidden by default) -->
        <div id="callInterface" class="hidden absolute bottom-20 right-0 w-80 bg-white rounded-lg shadow-xl border">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Start a Call</h3>
                    <button id="closeCallInterface" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                        <input type="text" id="callerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="callerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your phone number">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Call</label>
                        <select id="callReason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select a reason</option>
                            <option value="support">Technical Support</option>
                            <option value="sales">Sales Inquiry</option>
                            <option value="billing">Billing Question</option>
                            <option value="general">General Information</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Call Type</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" id="voiceCall" name="callType" value="voice" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Voice Call Only</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" id="videoCall" name="callType" value="video" class="mr-2">
                                <span class="text-sm text-gray-700">Video Call</span>
                            </label>
                        </div>
                    </div>
                    
                    <button id="startCallBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-phone mr-2"></i>
                        Start Call
                    </button>
                    
                    <button id="testAudioBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-microphone mr-2"></i>
                        Test Audio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Status Modal -->
    <div id="callStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="absolute bottom-24 right-6 w-80 bg-white rounded-lg shadow-xl border">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="callStatusTitle">Connecting...</h3>
                    <button id="closeCallStatus" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="text-center mb-4">
                    <div id="callStatusIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                        <i class="fas fa-phone text-blue-600 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-500 mb-4" id="callStatusMessage">Please wait while we connect you to an agent.</p>
                    
                    <!-- Local Video Preview -->
                    <div id="localVideoContainer" class="mb-4 hidden">
                        <video id="localVideo" class="w-full h-32 object-cover rounded-lg border-2 border-blue-300" muted autoplay playsinline></video>
                        <p class="text-xs text-gray-500 mt-1">Your camera</p>
                    </div>
                    
                    <!-- Remote Video Display -->
                    <div id="remoteVideoContainer" class="mb-4 hidden">
                        <video id="remoteVideo" class="w-full h-48 object-cover rounded-lg border-2 border-green-300" autoplay playsinline></video>
                        <p class="text-xs text-gray-500 mt-1">Agent</p>
                    </div>
                    
                    <div id="callProgress" class="mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-3">
                    <button id="cancelCallBtn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                        Cancel Call
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Modal functions
        function openSignupModal() {
            document.getElementById('signup-modal').classList.remove('hidden');
        }

        function closeSignupModal() {
            document.getElementById('signup-modal').classList.add('hidden');
        }

        function scrollToDemo() {
            document.getElementById('demo').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Close modal when clicking outside
        document.getElementById('signup-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSignupModal();
            }
        });

        // Form submission
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                // Here you would typically send the form data to your backend
                alert('Thank you for your interest! We\'ll be in touch soon.');
                closeSignupModal();
            });
        });

        // Call Widget Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const callButton = document.getElementById('callButton');
            const callInterface = document.getElementById('callInterface');
            const closeCallInterface = document.getElementById('closeCallInterface');
            const startCallBtn = document.getElementById('startCallBtn');
            const testAudioBtn = document.getElementById('testAudioBtn');
            const callStatusModal = document.getElementById('callStatusModal');
            const cancelCallBtn = document.getElementById('cancelCallBtn');

            // Floating Widget Elements
            const floatingCallWidget = document.getElementById('floatingCallWidget');
            const miniWidget = document.getElementById('miniWidget');
            const expandedWidget = document.getElementById('expandedWidget');
            const expandWidgetBtn = document.getElementById('expandWidgetBtn');
            const minimizeWidgetBtn = document.getElementById('minimizeWidgetBtn');
            const closeWidgetBtn = document.getElementById('closeWidgetBtn');
            const endCallMiniBtn = document.getElementById('endCallMiniBtn');
            const widgetEndCallBtn = document.getElementById('widgetEndCallBtn');
            const widgetMuteBtn = document.getElementById('widgetMuteBtn');
            const widgetVideoBtn = document.getElementById('widgetVideoBtn');
            const widgetScreenShareBtn = document.getElementById('widgetScreenShareBtn');

            // WebRTC variables
            let localStream = null;
            let peerConnection = null;
            let isAudioTesting = false;
            let remoteStream = null;
            let isInCall = false;
            let callId = null;
            let answerApplied = false; // Prevent duplicate answer processing
            let pendingRemoteCandidates = []; // Queue ICE candidates
            let screenStream = null;
            let isScreenSharing = false;
            
            // Floating Widget State
            let isWidgetExpanded = false;
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            
            // WebSocket connection for signaling (optional)
            // WebSocket client is now handled by WebSocketClient class
            // WebSocket URL is now dynamically determined by WebSocketClient class

            // Floating Widget Drag and Drop Functionality
            function initFloatingWidget() {
                // Make widgets draggable
                [miniWidget, expandedWidget].forEach(widget => {
                    if (widget) {
                        widget.addEventListener('mousedown', startDrag);
                        widget.addEventListener('touchstart', startDrag);
                    }
                });

                // Widget control buttons
                if (expandWidgetBtn) {
                    expandWidgetBtn.addEventListener('click', expandWidget);
                }
                if (minimizeWidgetBtn) {
                    minimizeWidgetBtn.addEventListener('click', minimizeWidget);
                }
                if (closeWidgetBtn) {
                    closeWidgetBtn.addEventListener('click', hideFloatingWidget);
                }
                if (endCallMiniBtn) {
                    endCallMiniBtn.addEventListener('click', endRealCall);
                }
                if (widgetEndCallBtn) {
                    widgetEndCallBtn.addEventListener('click', endRealCall);
                }
                if (widgetMuteBtn) {
                    widgetMuteBtn.addEventListener('click', toggleCallMute);
                }
                if (widgetVideoBtn) {
                    widgetVideoBtn.addEventListener('click', toggleCallVideo);
                }
                if (widgetScreenShareBtn) {
                    widgetScreenShareBtn.addEventListener('click', toggleScreenShare);
                }
            }

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                
                const rect = floatingCallWidget.getBoundingClientRect();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                dragOffset.x = clientX - rect.left;
                dragOffset.y = clientY - rect.top;
                
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', onDrag);
                document.addEventListener('touchend', stopDrag);
            }

            function onDrag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                const newX = clientX - dragOffset.x;
                const newY = clientY - dragOffset.y;
                
                // Keep widget within viewport bounds
                const maxX = window.innerWidth - floatingCallWidget.offsetWidth;
                const maxY = window.innerHeight - floatingCallWidget.offsetHeight;
                
                floatingCallWidget.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
                floatingCallWidget.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('touchend', stopDrag);
            }

            function expandWidget() {
                miniWidget.classList.add('hidden');
                expandedWidget.classList.remove('hidden');
                isWidgetExpanded = true;
            }

            function minimizeWidget() {
                expandedWidget.classList.add('hidden');
                miniWidget.classList.remove('hidden');
                isWidgetExpanded = false;
            }

            function showFloatingWidget() {
                floatingCallWidget.classList.remove('hidden');
                callWidget.classList.add('hidden'); // Hide original call button
            }

            function hideFloatingWidget() {
                floatingCallWidget.classList.add('hidden');
                callWidget.classList.remove('hidden'); // Show original call button
            }

            function updateFloatingWidgetTimer(timerText) {
                const miniTimer = document.getElementById('miniCallTimer');
                const expandedTimer = document.getElementById('expandedCallTimer');
                
                if (miniTimer) miniTimer.textContent = timerText;
                if (expandedTimer) expandedTimer.textContent = timerText;
            }

            function updateFloatingWidgetCallerName(name) {
                const miniName = document.getElementById('miniCallerName');
                const expandedName = document.getElementById('expandedCallerName');
                
                if (miniName) miniName.textContent = name;
                if (expandedName) expandedName.textContent = name;
            }

            // Toggle call interface
            callButton.addEventListener('click', function() {
                callInterface.classList.toggle('hidden');
            });

            // Close call interface
            closeCallInterface.addEventListener('click', function() {
                callInterface.classList.add('hidden');
            });

            // Start call
            startCallBtn.addEventListener('click', function() {
                // Prevent multiple calls
                if (isInCall || peerConnection) {
                    alert('A call is already in progress. Please wait or end the current call.');
                    return;
                }
                
                const callerName = document.getElementById('callerName').value;
                const callerPhone = document.getElementById('callerPhone').value;
                const callReason = document.getElementById('callReason').value;

                if (!callerName || !callerPhone || !callReason) {
                    alert('Please fill in all fields');
                    return;
                }

                // Hide call interface and show status modal
                callInterface.classList.add('hidden');
                callStatusModal.classList.remove('hidden');

                // Start real WebRTC call
                startRealCall(callerName, callerPhone, callReason);
            });

            // Test audio functionality
            testAudioBtn.addEventListener('click', function() {
                if (isAudioTesting) {
                    stopAudioTest();
                } else {
                    startAudioTest();
                }
            });

            // Cancel call
            cancelCallBtn.addEventListener('click', function() {
                callStatusModal.classList.add('hidden');
                resetCallForm();
            });

            // Close call status modal
            const closeCallStatus = document.getElementById('closeCallStatus');
            closeCallStatus.addEventListener('click', function() {
                callStatusModal.classList.add('hidden');
                resetCallForm();
            });

            // Close call status modal when clicking outside
            callStatusModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    callStatusModal.classList.add('hidden');
                    resetCallForm();
                }
            });

            function simulateCallConnection() {
                const statusTitle = document.getElementById('callStatusTitle');
                const statusMessage = document.getElementById('callStatusMessage');
                const statusIcon = document.getElementById('callStatusIcon');

                // Simulate connection steps
                setTimeout(() => {
                    statusTitle.textContent = 'Finding Agent...';
                    statusMessage.textContent = 'We\'re finding the best agent for your needs.';
                }, 2000);

                setTimeout(() => {
                    statusTitle.textContent = 'Agent Found!';
                    statusMessage.textContent = 'Connecting you to an agent now.';
                    statusIcon.innerHTML = '<i class="fas fa-user text-green-600 text-xl"></i>';
                    statusIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4';
                }, 5000);

                setTimeout(() => {
                    statusTitle.textContent = 'Connected!';
                    statusMessage.textContent = 'You are now connected to an agent.';
                    statusIcon.innerHTML = '<i class="fas fa-check text-green-600 text-xl"></i>';
                    
                    // Add call controls
                    const callControls = document.createElement('div');
                    callControls.innerHTML = `
                        <div class="flex justify-center space-x-3 mt-4">
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                                <i class="fas fa-microphone mr-2"></i>Mute
                            </button>
                            <button class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                                <i class="fas fa-phone-slash mr-2"></i>End Call
                            </button>
                        </div>
                    `;
                    document.getElementById('callProgress').parentNode.appendChild(callControls);
                }, 8000);
            }

            function resetCallForm() {
                document.getElementById('callerName').value = '';
                document.getElementById('callerPhone').value = '';
                document.getElementById('callReason').value = '';
                
                // Reset status modal
                document.getElementById('callStatusTitle').textContent = 'Connecting...';
                document.getElementById('callStatusMessage').textContent = 'Please wait while we connect you to an agent.';
                document.getElementById('callStatusIcon').innerHTML = '<i class="fas fa-phone text-blue-600 text-xl"></i>';
                document.getElementById('callStatusIcon').className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4';
                
                // Remove call controls if they exist
                const callControls = document.querySelector('#callProgress + div');
                if (callControls) {
                    callControls.remove();
                }
            }

            // WebRTC Audio Testing Functions
            async function startAudioTest() {
                try {
                    // Request microphone access
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: false 
                    });

                    // Create audio element to hear yourself
                    const audioElement = document.createElement('audio');
                    audioElement.srcObject = localStream;
                    audioElement.autoplay = true;
                    audioElement.muted = true; // Prevent feedback

                    // Update button state
                    isAudioTesting = true;
                    testAudioBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Test';
                    testAudioBtn.className = 'w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors flex items-center justify-center';

                    // Show success message
                    showAudioTestMessage('Audio test started! Speak into your microphone.', 'success');

                    // Store audio element for cleanup
                    testAudioBtn.audioElement = audioElement;

                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    showAudioTestMessage('Error: Could not access microphone. Please check permissions.', 'error');
                }
            }

            function stopAudioTest() {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }

                if (testAudioBtn.audioElement) {
                    testAudioBtn.audioElement.srcObject = null;
                    testAudioBtn.audioElement = null;
                }

                // Update button state
                isAudioTesting = false;
                testAudioBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Test Audio';
                testAudioBtn.className = 'w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center';

                showAudioTestMessage('Audio test stopped.', 'info');
            }

            function showAudioTestMessage(message, type) {
                // Create or update message element
                let messageElement = document.getElementById('audioTestMessage');
                if (!messageElement) {
                    messageElement = document.createElement('div');
                    messageElement.id = 'audioTestMessage';
                    messageElement.className = 'mt-3 p-3 rounded-md text-sm';
                    testAudioBtn.parentNode.appendChild(messageElement);
                }

                // Set message content and styling
                messageElement.textContent = message;
                messageElement.className = `mt-3 p-3 rounded-md text-sm ${
                    type === 'success' ? 'bg-green-100 text-green-800' :
                    type === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800'
                }`;

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (remoteStream) {
                    remoteStream.getTracks().forEach(track => track.stop());
                }
                // WebSocket cleanup handled by WebSocketClient
            });

            // Real WebRTC Call Functions
            async function startRealCall(callerName, callerPhone, callReason) {
                try {
                    console.log('Starting real WebRTC call...');
                    
                    // Reset call state for new call
                    isInCall = false;
                    answerApplied = false;
                    pendingRemoteCandidates = [];
                    
                    // Clean up any existing connection
                    if (peerConnection) {
                        peerConnection.close();
                        peerConnection = null;
                    }
                    
                    // Clear any existing call data to prevent conflicts
                    localStorage.removeItem('pendingCall');
                    localStorage.removeItem('callAnswer');
                    
                    // Update status
                    updateCallStatus('Connecting...', 'Please wait while we connect you to an agent.');
                    
                    // Check call type
                    const callType = document.querySelector('input[name="callType"]:checked').value;
                    console.log('Call type selected:', callType);
                    
                    // Get user media based on call type
                    if (callType === 'video') {
                        localStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: true, 
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                facingMode: 'user'
                            }
                        });
                    } else {
                        // Voice call only
                        localStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: true, 
                            video: false
                        });
                    }

                    // Show local video preview only for video calls
                    if (callType === 'video') {
                        const localVideo = document.getElementById('localVideo');
                        const localVideoContainer = document.getElementById('localVideoContainer');
                        if (localVideo && localVideoContainer) {
                            localVideo.srcObject = localStream;
                            localVideoContainer.classList.remove('hidden');
                            
                            // Force play local video
                            localVideo.play().then(() => {
                                console.log('Local video playing successfully');
                            }).catch(e => {
                                console.log('Local video autoplay blocked:', e);
                            });
                        }
                    }

                    // Create WebRTC peer connection with enhanced ICE servers for external connectivity
                    peerConnection = new RTCPeerConnection({
                        iceServers: [
                            // Google STUN servers
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            // Additional STUN servers for better connectivity
                            { urls: 'stun:stun.cloudflare.com:3478' },
                            { urls: 'stun:stun.voiparound.com' },
                            { urls: 'stun:stun.voipbuster.com' },
                            { urls: 'stun:stun.voipstunt.com' },
                            { urls: 'stun:stun.counterpath.com' },
                            { urls: 'stun:stun.1und1.de' },
                            // TURN servers for NAT traversal (free public TURN servers)
                            {
                                urls: 'turn:openrelay.metered.ca:80',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            },
                            {
                                urls: 'turn:openrelay.metered.ca:443',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            },
                            {
                                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            }
                        ],
                        iceCandidatePoolSize: 10
                    });
                    // Make peerConnection globally accessible
                    window.peerConnection = peerConnection;
                    console.log(' WebRTC peer connection created:', peerConnection);
                    console.log(' Debug: peerConnection in global scope:', window.peerConnection);

                    // Add local stream tracks
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    // Handle incoming tracks (remote audio + video from agent)
                    peerConnection.ontrack = (event) => {
                        console.log('Received remote stream:', event.streams[0]);
                        remoteStream = event.streams[0];
                        
                        // Check if stream has audio tracks
                        const audioTracks = remoteStream.getAudioTracks();
                        console.log(' Remote stream audio tracks:', audioTracks.length);
                        
                        if (audioTracks.length > 0) {
                            console.log(' Audio track details:', audioTracks[0].label, audioTracks[0].enabled, audioTracks[0].muted);
                        }
                        
                        // Handle remote audio
                        const remoteAudio = document.createElement('audio');
                        remoteAudio.id = 'remoteAudio';
                        remoteAudio.srcObject = remoteStream;
                        remoteAudio.autoplay = true;
                        remoteAudio.volume = 1.0;
                        remoteAudio.muted = false; // Ensure not muted
                        remoteAudio.controls = false; // Hide controls
                        
                        // Add event listeners for debugging
                        remoteAudio.addEventListener('loadstart', () => console.log(' Audio loadstart'));
                        remoteAudio.addEventListener('loadeddata', () => console.log(' Audio loadeddata'));
                        remoteAudio.addEventListener('canplay', () => console.log(' Audio canplay'));
                        remoteAudio.addEventListener('playing', () => console.log(' Audio playing'));
                        remoteAudio.addEventListener('error', (e) => console.error(' Audio error:', e));
                        
                        // Force play to overcome autoplay restrictions
                        remoteAudio.play().then(() => {
                            console.log(' Remote audio playing successfully');
                        }).catch(e => {
                            console.warn(' Autoplay blocked, user must interact first:', e);
                            // Show user-friendly message with enable audio button
                            updateCallStatus('Audio Blocked', 'Click the button below to enable audio');
                            showEnableAudioButton();
                        });
                        
                        document.body.appendChild(remoteAudio);
                        
                        // Handle remote video
                        const remoteVideo = document.getElementById('remoteVideo');
                        const remoteVideoContainer = document.getElementById('remoteVideoContainer');
                        console.log('Setting up remote video:', { remoteVideo, remoteVideoContainer, remoteStream });
                        
                        if (remoteVideo && remoteVideoContainer) {
                            remoteVideo.srcObject = remoteStream;
                            remoteVideoContainer.classList.remove('hidden');
                            console.log('Remote video container made visible');
                            
                            // Force play video with better error handling
                            remoteVideo.play().then(() => {
                                console.log('Remote video playing successfully');
                            }).catch(e => {
                                console.warn('Video autoplay blocked, showing enable button:', e);
                                // Show enable video button
                                showEnableVideoButton(remoteVideo);
                            });
                        } else {
                            console.error('Remote video elements not found!');
                            console.log('remoteVideo:', remoteVideo);
                            console.log('remoteVideoContainer:', remoteVideoContainer);
                        }
                        
                        console.log('Remote audio and video elements created');
                        
                        // Don't update UI here - let the answer processing handle it
                        // This prevents race conditions with the answer processing
                        console.log('ontrack: Remote media ready, waiting for answer processing to complete');
                    };

                    // Handle ICE candidates
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log('ICE candidate generated:', event.candidate);
                            console.log(' Candidate type:', event.candidate.type, 'protocol:', event.candidate.protocol, 'address:', event.candidate.address);
                        } else {
                            console.log(' ICE gathering complete - no more candidates');
                        }
                    };

                    // Handle connection state changes
                    peerConnection.onconnectionstatechange = (event) => {
                        console.log('Connection state:', peerConnection.connectionState);
                        if (peerConnection.connectionState === 'connected') {
                            console.log('WebRTC connection fully established!');
                            updateCallStatus('Connected!', 'Audio connection established successfully!');
                            
                            // Ensure we're in call state
                            if (!isInCall) {
                                isInCall = true;
                                showCallControls();
                                startCallTimer();
                                
                                // Show floating widget when call connects
                                showFloatingWidget();
                                updateFloatingWidgetCallerName('Agent');
                            }
                        } else if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                            console.log('WebRTC connection failed or disconnected');
                            isInCall = false;
                        }
                    };

                    // Enhanced ICE connection monitoring
                    peerConnection.oniceconnectionstatechange = (event) => {
                        console.log('ICE connection state:', peerConnection.iceConnectionState);
                        
                        // Handle ICE connection state changes
                        if (peerConnection.iceConnectionState === 'connected' || peerConnection.iceConnectionState === 'completed') {
                            console.log(' ICE connection established successfully!');
                            // Ensure call state is set if not already set
                            if (!isInCall) {
                                isInCall = true;
                                showCallControls();
                                startCallTimer();
                                showFloatingWidget();
                                updateFloatingWidgetCallerName('Agent');
                            }
                        } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                            console.log(' ICE connection failed or disconnected');
                            // Don't immediately set isInCall to false here as the connection state change handler will handle it
                        }
                        if (peerConnection.iceConnectionState === 'connected') {
                            console.log('ICE connection established - media should flow!');
                        } else if (peerConnection.iceConnectionState === 'failed') {
                            console.log('ICE connection failed - check network/firewall');
                        }
                    };

                    // Monitor ICE gathering state
                    peerConnection.onicegatheringstatechange = (event) => {
                        console.log('ICE gathering state:', peerConnection.iceGatheringState);
                    };

                    // Create offer
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);

                    // Generate unique call ID using crypto.randomUUID() for better uniqueness
                    callId = 'call_' + crypto.randomUUID();
                    
                    // Store call ID globally to prevent mismatches
                    window.currentCallId = callId;
                    
                    console.log('Generated new call ID:', callId);

                    // Store call data locally and send via WebSocket
                    const callData = {
                        type: 'offer',
                        offer: offer,
                        callId: callId,
                        callerName: callerName,
                        callerPhone: callerPhone,
                        callReason: callReason,
                        callType: callType, // Include call type in the data
                        timestamp: Date.now()
                    };
                    
                    // Store locally for reference
                    window.currentCallData = callData;
                    console.log('Call data prepared with ID:', callId);
                    
                    // Send offer via WebSocket if available
                    if (websocketClient && websocketClient.isConnected()) {
                        // In a real system, we'd send to a specific agent or queue
                        // For now, we'll broadcast to the room
                        websocketClient.notifyCallStarted(callId, 'public-calls', callType);
                        console.log('Call notification sent via WebSocket');
                        
                        // Also send the WebRTC offer so agents can create answers
                        websocketClient.sendWebRTCOffer('agent-room', offer, callId);
                        console.log('WebRTC offer sent to agents');
                    } else {
                        console.log('WebSocket not available, using fallback');
                    }

                    // Update status
                    updateCallStatus('Finding Agent...', 'We\'re finding the best agent for your needs.');
                    
                    // Check for agent answer immediately
                    checkForAgentAnswer();
                    
                    // Set up continuous checking until answer is received
                    const answerCheckInterval = setInterval(() => {
                        if (answerApplied || isInCall) {
                            console.log('Answer received or call connected, stopping answer checks');
                            clearInterval(answerCheckInterval);
                            return;
                        }
                        
                        console.log('Checking for agent answer...');
                        checkForAgentAnswer();
                    }, 1000); // Check every second until answer is received

                } catch (error) {
                    console.error('Error starting call:', error);
                    updateCallStatus('Error', 'Could not start call. Please check microphone permissions.');
                }
            }

            function sendSignalingMessage(message) {
                if (websocketClient && websocketClient.isConnected()) {
                    // Send message via WebSocketClient
                    websocketClient.send(message);
                } else {
                    // Fallback: simulate agent response for demo
                    setTimeout(() => simulateAgentResponse(), 2000);
                }
            }

            function simulateAgentResponse() {
                updateCallStatus('Agent Found!', 'Connecting you to an agent now.');
                
                setTimeout(() => {
                    updateCallStatus('Connected!', 'You are now connected to an agent.');
                    showCallControls();
                }, 2000);
            }

            function updateCallStatus(title, message) {
                const statusTitle = document.getElementById('callStatusTitle');
                const statusMessage = document.getElementById('callStatusMessage');
                if (statusTitle) statusTitle.textContent = title;
                if (statusMessage) statusMessage.textContent = message;
                
                // If call is connected, show call controls and start timer
                if (title === 'Call Connected') {
                    showCallControls();
                    startCallTimer();
                }
            }

            function showCallControls() {
                const callProgress = document.getElementById('callProgress');
                if (callProgress && callProgress.parentNode) {
                    // Check call type
                    const callType = document.querySelector('input[name="callType"]:checked')?.value || 'voice';
                    
                    const callControls = document.createElement('div');
                    callControls.innerHTML = `
                        <div class="flex justify-center space-x-3 mt-4">
                            <button id="muteBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                                <i class="fas fa-microphone mr-2"></i>Mute
                            </button>
                            ${callType === 'video' ? `
                            <button id="videoBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm font-medium hover:bg-purple-700">
                                <i class="fas fa-video mr-2"></i>Video Off
                            </button>
                            <button id="screenShareBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">
                                <i class="fas fa-desktop mr-2"></i>Share Screen
                            </button>
                            ` : ''}
                            <button id="endCallBtn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                                <i class="fas fa-phone-slash mr-2"></i>End Call
                            </button>
                        </div>
                    `;
                    callProgress.parentNode.appendChild(callControls);

                    // Add event listeners
                    document.getElementById('muteBtn').addEventListener('click', toggleCallMute);
                    if (callType === 'video') {
                        document.getElementById('videoBtn').addEventListener('click', toggleCallVideo);
                        document.getElementById('screenShareBtn').addEventListener('click', toggleScreenShare);
                    }
                    document.getElementById('endCallBtn').addEventListener('click', endRealCall);
                }
            }

            function tryEnableAudio() {
                console.log(' Attempting to enable audio proactively...');
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio && remoteAudio.srcObject) {
                    console.log(' Found remote audio element, attempting to play...');
                    remoteAudio.play().then(() => {
                        console.log(' Audio enabled proactively');
                    }).catch(e => {
                        console.log(' Proactive audio enable failed (expected for autoplay restrictions):', e.message);
                        // This is expected for autoplay restrictions, so we don't show error
                    });
                } else {
                    console.log(' Remote audio element not ready yet');
                }
            }

            function checkAudioStatus() {
                console.log(' Checking audio status...');
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio && remoteAudio.srcObject) {
                    // Check if audio is actually playing
                    if (remoteAudio.paused) {
                        console.log(' Audio is paused, showing enable button');
                        updateCallStatus('Audio Blocked', 'Click the button below to enable audio');
                        showEnableAudioButton();
                    } else {
                        console.log(' Audio is playing successfully');
                    }
                } else {
                    console.log(' No remote audio element found');
                }
            }

            function showEnableAudioButton() {
                const callProgress = document.getElementById('callProgress');
                if (callProgress && callProgress.parentNode) {
                    // Remove any existing enable audio button
                    const existingBtn = document.getElementById('enableAudioBtn');
                    if (existingBtn) existingBtn.remove();
                    
                    const enableAudioBtn = document.createElement('button');
                    enableAudioBtn.id = 'enableAudioBtn';
                    enableAudioBtn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Enable Audio';
                    enableAudioBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 mt-2';
                    enableAudioBtn.addEventListener('click', () => {
                        console.log(' Enable audio button clicked');
                        const remoteAudio = document.getElementById('remoteAudio');
                        if (remoteAudio) {
                            console.log(' Remote audio element found:', remoteAudio);
                            console.log(' Audio srcObject:', remoteAudio.srcObject);
                            console.log(' Audio muted:', remoteAudio.muted);
                            console.log(' Audio volume:', remoteAudio.volume);
                            
                            // Try to play the audio
                            remoteAudio.play().then(() => {
                                console.log(' Audio enabled successfully');
                                updateCallStatus('Connected!', 'Audio is now working!');
                                enableAudioBtn.remove();
                                showCallControls();
                            }).catch(e => {
                                console.error(' Failed to enable audio:', e);
                                updateCallStatus('Audio Error', 'Could not enable audio. Please check browser settings.');
                            });
                        } else {
                            console.error(' Remote audio element not found');
                            updateCallStatus('Audio Error', 'Audio element not found. Please refresh and try again.');
                        }
                    });
                    
                    callProgress.parentNode.appendChild(enableAudioBtn);
                }
            }

            function startCallTimer() {
                if (window.callTimerInterval) {
                    clearInterval(window.callTimerInterval);
                }
                
                window.callStartTime = Date.now();
                window.callTimerInterval = setInterval(() => {
                    const elapsed = Date.now() - window.callStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timerElement = document.getElementById('callTimer');
                    if (timerElement) {
                        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
            
            function showEnableVideoButton(videoElement) {
                const callProgress = document.getElementById('callProgress');
                if (callProgress && callProgress.parentNode) {
                    // Remove any existing enable video button
                    const existingBtn = document.getElementById('enableVideoBtn');
                    if (existingBtn) existingBtn.remove();
                    
                    const enableVideoBtn = document.createElement('button');
                    enableVideoBtn.id = 'enableVideoBtn';
                    enableVideoBtn.innerHTML = '<i class="fas fa-video mr-2"></i>Enable Video';
                    enableVideoBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 mt-2';
                    enableVideoBtn.addEventListener('click', () => {
                        if (videoElement) {
                            videoElement.play().then(() => {
                                console.log('Video enabled successfully');
                                enableVideoBtn.remove();
                            }).catch(e => {
                                console.error('Failed to enable video:', e);
                            });
                        }
                    });
                    
                    callProgress.parentNode.appendChild(enableVideoBtn);
                }
            }

            function toggleCallMute() {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        const muteBtn = document.getElementById('muteBtn');
                        const widgetMuteBtn = document.getElementById('widgetMuteBtn');
                        
                        if (audioTrack.enabled) {
                            if (muteBtn) {
                                muteBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Mute';
                                muteBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700';
                            }
                            if (widgetMuteBtn) {
                                widgetMuteBtn.innerHTML = '<i class="fas fa-microphone text-gray-600 text-sm"></i>';
                                widgetMuteBtn.className = 'w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors';
                            }
                        } else {
                            if (muteBtn) {
                                muteBtn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>Unmute';
                                muteBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700';
                            }
                            if (widgetMuteBtn) {
                                widgetMuteBtn.innerHTML = '<i class="fas fa-microphone-slash text-red-600 text-sm"></i>';
                                widgetMuteBtn.className = 'w-10 h-10 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors';
                            }
                        }
                    }
                }
            }

            function toggleCallVideo() {
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        const videoBtn = document.getElementById('videoBtn');
                        const widgetVideoBtn = document.getElementById('widgetVideoBtn');
                        const localVideo = document.getElementById('localVideo');
                        
                        if (videoTrack.enabled) {
                            if (videoBtn) {
                                videoBtn.innerHTML = '<i class="fas fa-video mr-2"></i>Video Off';
                                videoBtn.className = 'px-4 py-2 bg-purple-600 text-white rounded-md text-sm font-medium hover:bg-purple-700';
                            }
                            if (widgetVideoBtn) {
                                widgetVideoBtn.innerHTML = '<i class="fas fa-video text-gray-600 text-sm"></i>';
                                widgetVideoBtn.className = 'w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors';
                            }
                            if (localVideo) localVideo.style.opacity = '1';
                        } else {
                            if (videoBtn) {
                                videoBtn.innerHTML = '<i class="fas fa-video-slash mr-2"></i>Video On';
                                videoBtn.className = 'px-4 py-2 bg-gray-600 text-white rounded-md text-sm font-medium hover:bg-gray-700';
                            }
                            if (widgetVideoBtn) {
                                widgetVideoBtn.innerHTML = '<i class="fas fa-video-slash text-red-600 text-sm"></i>';
                                widgetVideoBtn.className = 'w-10 h-10 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors';
                            }
                            if (localVideo) localVideo.style.opacity = '0.5';
                        }
                    }
                }
            }

            async function toggleScreenShare() {
                const screenShareBtn = document.getElementById('screenShareBtn');
                const widgetScreenShareBtn = document.getElementById('widgetScreenShareBtn');
                
                if (!isScreenSharing) {
                    try {
                        // Start screen sharing
                        screenStream = await navigator.mediaDevices.getDisplayMedia({
                            video: {
                                cursor: 'always',
                                displaySurface: 'monitor'
                            },
                            audio: false
                        });
                        
                        isScreenSharing = true;
                        if (screenShareBtn) {
                            screenShareBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Sharing';
                            screenShareBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700';
                        }
                        if (widgetScreenShareBtn) {
                            widgetScreenShareBtn.innerHTML = '<i class="fas fa-stop text-red-600 text-sm"></i>';
                            widgetScreenShareBtn.className = 'w-10 h-10 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors';
                        }
                        
                        // Replace video track with screen track
                        if (peerConnection && localStream) {
                            const videoTrack = screenStream.getVideoTracks()[0];
                            const sender = peerConnection.getSenders().find(s => 
                                s.track && s.track.kind === 'video'
                            );
                            
                            if (sender) {
                                sender.replaceTrack(videoTrack);
                                console.log('Screen sharing track replaced successfully');
                            }
                        }
                        
                        // Handle screen share stop
                        screenStream.getVideoTracks()[0].onended = () => {
                            stopScreenShare();
                        };
                        
                        console.log('Screen sharing started successfully');
                        
                    } catch (error) {
                        console.error('Error starting screen share:', error);
                        alert('Could not start screen sharing. Please check permissions.');
                    }
                } else {
                    stopScreenShare();
                }
            }

            function stopScreenShare() {
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                isScreenSharing = false;
                const screenShareBtn = document.getElementById('screenShareBtn');
                const widgetScreenShareBtn = document.getElementById('widgetScreenShareBtn');
                
                if (screenShareBtn) {
                    screenShareBtn.innerHTML = '<i class="fas fa-desktop mr-2"></i>Share Screen';
                    screenShareBtn.className = 'px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700';
                }
                if (widgetScreenShareBtn) {
                    widgetScreenShareBtn.innerHTML = '<i class="fas fa-desktop text-gray-600 text-sm"></i>';
                    widgetScreenShareBtn.className = 'w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors';
                }
                
                // Restore original video track
                if (peerConnection && localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    
                    if (sender && videoTrack) {
                        sender.replaceTrack(videoTrack);
                        console.log('Original video track restored');
                    }
                }
                
                console.log('Screen sharing stopped');
            }

            function endRealCall() {
                console.log('endRealCall called');
                console.trace('endRealCall stack trace'); // This will show us where it's called from
                
                // Prevent ending call if we're in the middle of processing an answer
                if (answerApplied && !isInCall) {
                    console.log('endRealCall blocked - answer is being processed');
                    return;
                }
                
                // Stop call timer
                stopCallTimer();
                
                // Reset call state
                isInCall = false;
                
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (remoteStream) {
                    remoteStream.getTracks().forEach(track => track.stop());
                    remoteStream = null;
                }

                // Remove remote audio
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio) {
                    remoteAudio.remove();
                }

                // Hide video containers
                const localVideoContainer = document.getElementById('localVideoContainer');
                const remoteVideoContainer = document.getElementById('remoteVideoContainer');
                if (localVideoContainer) localVideoContainer.classList.add('hidden');
                if (remoteVideoContainer) remoteVideoContainer.classList.add('hidden');

                // Stop screen sharing if active
                if (isScreenSharing) {
                    stopScreenShare();
                }

                // Hide floating widget and show original call button
                hideFloatingWidget();

                // Hide modal and reset
                document.getElementById('callStatusModal').classList.add('hidden');
                resetCallForm();
            }

            // Add global error handlers to catch any unhandled issues
            window.addEventListener('error', (event) => {
                console.error('Global error caught:', event.error);
            });
            
            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
            });

            // Initialize WebSocket connection - using new WebSocketClient
            function initWebSocket() {
                // The new WebSocketClient is initialized in the main initialization
                // This function is kept for compatibility but doesn't do anything
                console.log('WebSocket initialization handled by WebSocketClient');
            }

            // Check for agent answer function - WebSocket based
            function checkForAgentAnswer() {
                console.log('checkForAgentAnswer called - isInCall:', isInCall, 'peerConnection:', !!peerConnection, 'connectionState:', peerConnection?.connectionState, 'answerApplied:', answerApplied);
                
                // Don't check if we're already in a call or if peer connection is not ready
                if (isInCall || !peerConnection || peerConnection.connectionState === 'connected' || answerApplied) {
                    console.log('checkForAgentAnswer returning early due to conditions not met');
                    return;
                }

                // Clean up stale call data
                cleanupStaleCallData();

                // With WebSocket, we don't need to poll localStorage
                // The answer will come through the WebSocket message handler
                console.log('WebSocket-based answer checking - no polling needed');
                
                // Stop checking if we've been checking for too long (30 seconds)
                if (!window.answerCheckStartTime) {
                    window.answerCheckStartTime = Date.now();
                }
                
                if (Date.now() - window.answerCheckStartTime > 30000) {
                    console.log(' Agent answer check timeout - stopping checks');
                    if (window.answerCheckInterval) {
                        clearInterval(window.answerCheckInterval);
                        window.answerCheckInterval = null;
                    }
                    updateCallStatus('Call Failed', 'Agent did not respond in time');
                    return;
                }
            }

            // Queue ICE candidates until remote description is set
            function handleRemoteCandidate(candidateMsg) {
                if (candidateMsg.callId !== callId && candidateMsg.callId !== window.currentCallId) {
                    return;
                }

                const candidate = new RTCIceCandidate(candidateMsg.candidate);
                if (peerConnection.remoteDescription && peerConnection.remoteDescription.type) {
                    peerConnection.addIceCandidate(candidate).catch(console.error);
                } else {
                    pendingRemoteCandidates.push(candidate);
                    console.log('Queued ICE candidate, waiting for remote description');
                }
            }

            // Flush queued ICE candidates after remote description is set
            function flushQueuedRemoteCandidates() {
                console.log('Flushing', pendingRemoteCandidates.length, 'queued ICE candidates');
                while (pendingRemoteCandidates.length) {
                    peerConnection.addIceCandidate(pendingRemoteCandidates.shift()).catch(console.error);
                }
            }

            // Clean up stale call data to prevent conflicts
            function cleanupStaleCallData() {
                const pendingCall = localStorage.getItem('pendingCall');
                if (pendingCall) {
                    try {
                        const callData = JSON.parse(pendingCall);
                        const now = Date.now();
                        
                        // Remove calls older than 30 seconds
                        if (now - callData.timestamp > 30000) {
                            console.log('Removing stale pending call:', callData.callId);
                            localStorage.removeItem('pendingCall');
                        }
                    } catch (error) {
                        console.error('Error parsing pending call for cleanup:', error);
                        localStorage.removeItem('pendingCall');
                    }
                }

                const callAnswer = localStorage.getItem('callAnswer');
                if (callAnswer) {
                    try {
                        const answerData = JSON.parse(callAnswer);
                        const now = Date.now();
                        
                        // Remove answers older than 30 seconds
                        if (now - answerData.timestamp > 30000) {
                            console.log('Removing stale call answer:', answerData.callId);
                            localStorage.removeItem('callAnswer');
                        }
                    } catch (error) {
                        console.error('Error parsing call answer for cleanup:', error);
                        localStorage.removeItem('callAnswer');
                    }
                }
            }

            // Call timer functionality
            let callTimerInterval;
            let callStartTime;

            function startCallTimer() {
                callStartTime = Date.now();
                callTimerInterval = setInterval(updateCallTimer, 1000);
                console.log('Call timer started');
            }

            function stopCallTimer() {
                if (callTimerInterval) {
                    clearInterval(callTimerInterval);
                    callTimerInterval = null;
                }
            }

            function updateCallTimer() {
                const elapsed = Date.now() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update both modal and floating widget timers
                const timerElement = document.getElementById('callTimer');
                if (timerElement) {
                    timerElement.textContent = timerText;
                }
                
                // Update floating widget timer
                updateFloatingWidgetTimer(timerText);
            }

            // Initialize WebSocket on page load
            initWebSocket();
            
            // Initialize floating widget
            initFloatingWidget();
            
            // REMOVED: Problematic setInterval that was causing duplicate answer processing
            // Now using single event-driven answer processing with retry mechanism

            // Add audio test button
            function addAudioTestButton() {
                const header = document.querySelector('header');
                if (header) {
                    const testButton = document.createElement('button');
                    testButton.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Test Audio';
                    testButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors';
                    testButton.addEventListener('click', testAudio);
                    header.querySelector('.flex').appendChild(testButton);
                }
            }

            // Test audio function
            async function testAudio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: false 
                    });
                    
                    const audioElement = document.createElement('audio');
                    audioElement.srcObject = stream;
                    audioElement.autoplay = true;
                    audioElement.muted = true; // Prevent feedback
                    
                    alert('Audio test successful! Microphone access granted. You can hear yourself (muted to prevent feedback).');
                    
                    setTimeout(() => {
                        stream.getTracks().forEach(track => track.stop());
                        audioElement.remove();
                    }, 5000);
                    
                } catch (error) {
                    console.error('Audio test failed:', error);
                    alert('Audio test failed: ' + error.message);
                }
            }

            // WebSocket Message Handlers - moved inside main script block to access peerConnection
            // WebSocket Message Handlers - Made globally accessible
            window.handleIncomingOffer = function(message) {
                console.log(' Received WebRTC offer:', message);
                // This would handle incoming calls from agents
                // For now, we'll just log it
            };
            
            window.handleIncomingAnswer = async function(message) {
                console.log(' Received WebRTC answer from agent:', message);
                console.log(' Debug: peerConnection available?', !!window.peerConnection);
                console.log(' Debug: peerConnection type:', typeof window.peerConnection);
                console.log(' Debug: peerConnection value:', window.peerConnection);
                
                if (window.peerConnection && message.answer) {
                    try {
                        const answer = new RTCSessionDescription(message.answer);
                        await window.peerConnection.setRemoteDescription(answer);
                        console.log(' Agent answer set as remote description');
                        
                        // Flush any queued ICE candidates now that remote description is set
                        flushQueuedRemoteCandidates();
                        
                        // Mark answer as applied to prevent duplicate processing
                        answerApplied = true;
                        
                        // Stop checking for agent answer since we got it
                        if (window.answerCheckInterval) {
                            clearInterval(window.answerCheckInterval);
                            window.answerCheckInterval = null;
                        }
                        
                        // Set call state to connected
                        isInCall = true;
                        
                        // Update call status to connected
                        updateCallStatus('Call Connected', 'Connected with agent');
                        
                        // Show call controls and start call timer
                        showCallControls();
                        startCallTimer();
                        
                        // Show floating widget when call connects
                        showFloatingWidget();
                        updateFloatingWidgetCallerName('Agent');
                        
                        // Try to enable audio proactively
                        setTimeout(() => {
                            tryEnableAudio();
                        }, 1000);
                        
                        // Check if audio is working after a delay
                        setTimeout(() => {
                            checkAudioStatus();
                        }, 3000);
                        
                        console.log(' Call connected successfully with agent');
                        
                    } catch (error) {
                        console.error(' Error setting remote description:', error);
                    }
                } else {
                    console.error(' No peer connection or answer in message');
                }
            };
            
            window.handleIncomingICECandidate = function(message) {
                console.log(' Received ICE candidate:', message);
                if (window.peerConnection && message.candidate) {
                    try {
                        const candidate = new RTCIceCandidate(message.candidate);
                        window.peerConnection.addIceCandidate(candidate);
                        console.log(' ICE candidate added successfully');
                    } catch (error) {
                        console.error(' Error adding ICE candidate:', error);
                    }
                } else {
                    console.error(' Cannot add ICE candidate:', {
                        peerConnection: !!window.peerConnection,
                        candidate: !!message.candidate
                    });
                }
            };
            
            window.handleCallStarted = function(message) {
                console.log(' Call started:', message);
                // Update UI to show call is active
            };
            
            window.handleCallEnded = function(message) {
                console.log(' Call ended:', message);
                // End the call and clean up
                endRealCall();
            };

            // Add test button on page load
            document.addEventListener('DOMContentLoaded', addAudioTestButton);
            
            // Initialize WebSocket connection
            document.addEventListener('DOMContentLoaded', function() {
                initializeWebSocket();
            });
        });
    </script>

    <!-- IVR Queue System -->
    <div id="ivrQueueSystem" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 overflow-hidden">
                <!-- IVR Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">CallDocker IVR System</h2>
                            <p class="text-blue-100" id="ivrStatus">Connecting to our system...</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-blue-100">Queue Position</div>
                            <div class="text-3xl font-bold" id="queuePosition">--</div>
                        </div>
                    </div>
                </div>

                <!-- IVR Content -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
                    <!-- Video/Media Section -->
                    <div class="bg-gray-900 p-6 flex items-center justify-center min-h-96">
                        <div class="text-center">
                            <!-- Company Video/Logo -->
                            <div id="companyVideo" class="mb-4">
                                <video id="holdVideo" class="w-full max-w-md rounded-lg" autoplay muted loop>
                                    <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            
                            <!-- Company Info -->
                            <div class="text-white">
                                <h3 class="text-xl font-semibold mb-2">Welcome to CallDocker</h3>
                                <p class="text-gray-300 text-sm">Your call is important to us</p>
                            </div>
                        </div>
                    </div>

                    <!-- IVR Controls & Info -->
                    <div class="bg-white p-6">
                        <!-- Call Progress -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Estimated Wait Time</span>
                                <span class="text-sm text-gray-500" id="estimatedWait">Calculating...</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="waitProgress" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- IVR Menu Options -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">While You Wait:</h4>
                            <div class="space-y-3">
                                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="selectIvrOption('callback')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-gray-900"> Request Callback</div>
                                            <div class="text-sm text-gray-600">We'll call you back when an agent is available</div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                    </div>
                                </button>
                                
                                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="selectIvrOption('faq')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-gray-900"> View FAQs</div>
                                            <div class="text-sm text-gray-600">Find answers to common questions</div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                    </div>
                                </button>
                                
                                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="selectIvrOption('chat')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-gray-900"> Live Chat</div>
                                            <div class="text-sm text-gray-600">Start a text chat with an agent</div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Call Controls -->
                        <div class="border-t pt-4">
                            <div class="flex space-x-3">
                                <button id="muteHoldMusic" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i class="fas fa-volume-mute mr-2"></i>Mute Music
                                </button>
                                <button id="endIvrCall" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="fas fa-phone-slash mr-2"></i>End Call
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hold Music Audio Element -->
    <audio id="holdMusic" loop>
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>

    <!-- Callback Modal -->
    <div id="callbackModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-60">
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Request Callback</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="callbackPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your phone number">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Best Time to Call</label>
                        <select id="callbackTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="asap">As soon as possible</option>
                            <option value="morning">Morning (9 AM - 12 PM)</option>
                            <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                            <option value="evening">Evening (5 PM - 8 PM)</option>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeCallbackModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="submitCallback()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebSocket Client -->
    <script src="js/websocket-client.js?v=2"></script>
    
    <!-- IVR System JavaScript -->
    <script>
        // IVR System Variables
        let ivrQueuePosition = 0;
        let ivrWaitTime = 0;
        let ivrTimer = null;
        let holdMusicMuted = false;
        let ivrCallData = null;
        
        // WebSocket and WebRTC Variables
        let websocketClient = null;
        let currentCallId = null;
        let currentRoomId = null;
        
        // Initialize WebSocket connection for anonymous users
        function initializeWebSocket() {
            // For anonymous users, we'll use a mock token
            // In production, this would be handled differently
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImFub255bW91cyIsInJvbGUiOiJ1c2VyIiwiY29tcGFueV9pZCI6ImRlZmF1bHQiLCJpYXQiOjE2NzI1NDU2NzB9.mock_signature';
            
            websocketClient = new WebSocketClient(
                mockToken,
                handleWebSocketMessage,
                handleWebSocketConnect,
                handleWebSocketDisconnect
            );
        }
        
        function handleWebSocketMessage(message) {
            console.log(' WebSocket message received:', message.type);
            
            switch (message.type) {
                case 'connection_established':
                    console.log(' WebSocket connection established');
                    break;
                case 'room_joined':
                    console.log(' Joined room:', message.roomId);
                    break;
                case 'pong':
                    // Heartbeat response - no action needed
                    break;
                case 'webrtc_offer':
                    handleIncomingOffer(message);
                    break;
                case 'webrtc_answer':
                    handleIncomingAnswer(message);
                    break;
                case 'ice_candidate':
                    handleIncomingICECandidate(message);
                    break;
                case 'call_started':
                    handleCallStarted(message);
                    break;
                case 'call_ended':
                    handleCallEnded(message);
                    break;
                default:
                    console.log(' Unknown message type:', message.type);
            }
        }
        
        function handleWebSocketConnect() {
            console.log(' WebSocket connected');
            // Join default room for incoming calls
            if (websocketClient) {
                websocketClient.joinRoom('public-calls');
            }
        }
        
        function handleWebSocketDisconnect() {
            console.log(' WebSocket disconnected');
        }
        


        // Enhanced IVR Flow with Queue System
        async function startIvrQueueSystem(callerName, callerPhone, callReason, callType) {
            console.log('Starting IVR Queue System...');
            
            // Store call data
            ivrCallData = {
                callerName,
                callerPhone,
                callReason,
                callType,
                timestamp: Date.now()
            };

            // Show IVR Queue System
            document.getElementById('ivrQueueSystem').classList.remove('hidden');
            
            // Start IVR flow
            await runIvrFlow();
        }

        async function runIvrFlow() {
            try {
                // Step 1: Welcome and Initial Processing
                updateIvrStatus('Welcome to CallDocker', 'Processing your request...');
                await sleep(2000);

                // Step 2: Route based on call reason
                const routingMessage = getRoutingMessage(ivrCallData.callReason);
                updateIvrStatus('Routing Your Call', routingMessage);
                await sleep(3000);

                // Step 3: Enter Queue
                updateIvrStatus('Entering Queue', 'Finding the best agent for your needs...');
                await sleep(2000);

                // Step 4: Start Queue Simulation
                startQueueSimulation();

            } catch (error) {
                console.error('IVR Flow Error:', error);
                updateIvrStatus('Error', 'Please try again or contact support.');
            }
        }

        function getRoutingMessage(callReason) {
            const messages = {
                'support': 'Routing to Technical Support Department',
                'sales': 'Routing to Sales Team',
                'billing': 'Routing to Billing Department',
                'general': 'Routing to General Support'
            };
            return messages[callReason] || 'Routing to available agent';
        }

        function startQueueSimulation() {
            // Simulate queue position
            ivrQueuePosition = Math.floor(Math.random() * 10) + 1;
            ivrWaitTime = Math.floor(Math.random() * 300) + 60; // 1-6 minutes
            
            updateIvrStatus('In Queue', `You are position ${ivrQueuePosition} in the queue`);
            updateQueuePosition(ivrQueuePosition);
            updateEstimatedWaitTime(formatWaitTime(ivrWaitTime));
            
            // Start hold music
            startHoldMusic();
            
            // Start queue countdown
            startQueueCountdown();
            
            // Simulate agent availability
            simulateAgentAvailability();
        }

        function startQueueCountdown() {
            let timeElapsed = 0;
            const totalWaitTime = ivrWaitTime;
            
            ivrTimer = setInterval(() => {
                timeElapsed += 1;
                const remainingTime = Math.max(0, totalWaitTime - timeElapsed);
                
                // Update progress bar
                const progress = Math.min(100, (timeElapsed / totalWaitTime) * 100);
                document.getElementById('waitProgress').style.width = `${progress}%`;
                
                // Update estimated wait time
                updateEstimatedWaitTime(formatWaitTime(remainingTime));
                
                // Update queue position (simulate moving up)
                if (timeElapsed % 30 === 0 && ivrQueuePosition > 1) {
                    ivrQueuePosition--;
                    updateQueuePosition(ivrQueuePosition);
                }
                
                // Check if agent is available
                if (remainingTime <= 0) {
                    clearInterval(ivrTimer);
                    connectToAgent();
                }
            }, 1000);
        }

        function simulateAgentAvailability() {
            // Simulate agent becoming available after random time
            const agentWaitTime = Math.floor(Math.random() * ivrWaitTime) + 30;
            
            setTimeout(() => {
                if (ivrTimer) { // Only if still in queue
                    clearInterval(ivrTimer);
                    connectToAgent();
                }
            }, agentWaitTime * 1000);
        }

        function connectToAgent() {
            updateIvrStatus('Connecting to Agent', 'An agent is now available!');
            stopHoldMusic();
            
            setTimeout(() => {
                // Hide IVR system and start actual call
                document.getElementById('ivrQueueSystem').classList.add('hidden');
                startRealCall(ivrCallData.callerName, ivrCallData.callerPhone, ivrCallData.callReason);
            }, 2000);
        }

        function startHoldMusic() {
            const holdMusic = document.getElementById('holdMusic');
            holdMusic.volume = 0.3;
            
            // Try to play hold music
            holdMusic.play().then(() => {
                console.log('Hold music started');
            }).catch(error => {
                console.log('Hold music autoplay blocked:', error);
                // Show unmute button
                showUnmuteButton();
            });
        }

        function stopHoldMusic() {
            const holdMusic = document.getElementById('holdMusic');
            holdMusic.pause();
            holdMusic.currentTime = 0;
        }

        function showUnmuteButton() {
            const muteBtn = document.getElementById('muteHoldMusic');
            muteBtn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Enable Music';
            muteBtn.onclick = enableHoldMusic;
        }

        function enableHoldMusic() {
            const holdMusic = document.getElementById('holdMusic');
            holdMusic.play().then(() => {
                const muteBtn = document.getElementById('muteHoldMusic');
                muteBtn.innerHTML = '<i class="fas fa-volume-mute mr-2"></i>Mute Music';
                muteBtn.onclick = toggleHoldMusic;
            });
        }

        function toggleHoldMusic() {
            const holdMusic = document.getElementById('holdMusic');
            const muteBtn = document.getElementById('muteHoldMusic');
            
            if (holdMusic.paused) {
                holdMusic.play();
                muteBtn.innerHTML = '<i class="fas fa-volume-mute mr-2"></i>Mute Music';
            } else {
                holdMusic.pause();
                muteBtn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Enable Music';
            }
        }

        // IVR Option Handlers
        function selectIvrOption(option) {
            switch(option) {
                case 'callback':
                    showCallbackModal();
                    break;
                case 'faq':
                    showFaqSection();
                    break;
                case 'chat':
                    startLiveChat();
                    break;
            }
        }

        function showCallbackModal() {
            document.getElementById('callbackModal').classList.remove('hidden');
        }

        function closeCallbackModal() {
            document.getElementById('callbackModal').classList.add('hidden');
        }

        function submitCallback() {
            const phone = document.getElementById('callbackPhone').value;
            const time = document.getElementById('callbackTime').value;
            
            if (phone) {
                console.log('Callback requested:', { phone, time });
                closeCallbackModal();
                updateIvrStatus('Callback Requested', 'We will call you back shortly');
                
                // Simulate callback confirmation
                setTimeout(() => {
                    updateIvrStatus('In Queue', 'You are still in queue for immediate assistance');
                }, 3000);
            }
        }

        function showFaqSection() {
            // Create FAQ overlay
            const faqContent = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Frequently Asked Questions</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900">How do I reset my password?</h4>
                            <p class="text-sm text-gray-600 mt-1">Click on "Forgot Password" on the login page and follow the instructions sent to your email.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">What are your business hours?</h4>
                            <p class="text-sm text-gray-600 mt-1">We're available Monday-Friday 9 AM to 6 PM EST, and 24/7 for urgent technical issues.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">How can I upgrade my plan?</h4>
                            <p class="text-sm text-gray-600 mt-1">You can upgrade your plan anytime from your account dashboard or contact our sales team.</p>
                        </div>
                    </div>
                    <button onclick="closeFaqSection()" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        Close
                    </button>
                </div>
            `;
            
            // Show FAQ overlay
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-70';
            overlay.innerHTML = faqContent;
            overlay.id = 'faqOverlay';
            document.body.appendChild(overlay);
        }

        function closeFaqSection() {
            const overlay = document.getElementById('faqOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function startLiveChat() {
            updateIvrStatus('Starting Live Chat', 'Redirecting you to our chat system...');
            
            // Simulate chat redirection
            setTimeout(() => {
                alert('Live chat feature coming soon! For now, please continue waiting for an agent.');
                updateIvrStatus('In Queue', 'You are still in queue for immediate assistance');
            }, 2000);
        }

        // Utility Functions
        function updateIvrStatus(title, message) {
            document.getElementById('ivrStatus').textContent = message;
        }

        function updateQueuePosition(position) {
            document.getElementById('queuePosition').textContent = position;
        }

        function updateEstimatedWaitTime(time) {
            document.getElementById('estimatedWait').textContent = time;
        }

        function formatWaitTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // IVR System Event Listeners
            const muteBtn = document.getElementById('muteHoldMusic');
            const endBtn = document.getElementById('endIvrCall');
            
            if (muteBtn) {
                muteBtn.addEventListener('click', toggleHoldMusic);
            }
            if (endBtn) {
                endBtn.addEventListener('click', endIvrCall);
            }
        });

        function endIvrCall() {
            if (ivrTimer) {
                clearInterval(ivrTimer);
            }
            stopHoldMusic();
            document.getElementById('ivrQueueSystem').classList.add('hidden');
            console.log('IVR call ended by user');
        }

        // Override the original startRealCall to use IVR system
        const originalStartRealCall = window.startRealCall;
        window.startRealCall = function(callerName, callerPhone, callReason) {
            const callType = document.querySelector('input[name="callType"]:checked').value;
            startIvrQueueSystem(callerName, callerPhone, callReason, callType);
        };

        // Check for test IVR flow on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize WebSocket connection
            initializeWebSocket();
            
            // Check if this is a test IVR page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test-ivr') === 'true') {
                const testFlow = localStorage.getItem('testIvrFlow');
                if (testFlow) {
                    const flow = JSON.parse(testFlow);
                    console.log('Testing IVR flow:', flow);
                    
                    // Show test mode indicator
                    showTestModeIndicator(flow);
                    
                    // Auto-start the IVR test
                    setTimeout(() => {
                        startIvrQueueSystem('Test User', '555-0123', 'test', 'voice');
                    }, 1000);
                }
            }
        });

        function showTestModeIndicator(flow) {
            const indicator = document.createElement('div');
            indicator.className = 'fixed top-4 left-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            indicator.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-flask mr-2"></i>
                    <span>Testing IVR Flow: ${flow.name}</span>
                </div>
            `;
            document.body.appendChild(indicator);
            
            // Remove indicator after 5 seconds
            setTimeout(() => {
                indicator.remove();
            }, 5000);
        }

        // Override the IVR flow to use test flow if available
        const originalRunIvrFlow = runIvrFlow;
        runIvrFlow = async function() {
            const testFlow = localStorage.getItem('testIvrFlow');
            if (testFlow) {
                const flow = JSON.parse(testFlow);
                await runTestIvrFlow(flow);
            } else {
                await originalRunIvrFlow();
            }
        };

        async function runTestIvrFlow(flow) {
            try {
                // Step 1: Welcome and Initial Processing
                updateIvrStatus('Welcome', 'Processing your request...');
                await sleep(2000);

                // Step 2: Play custom welcome message
                updateIvrStatus('Welcome', flow.welcomeMessage);
                await sleep(4000);

                // Step 3: Show menu options
                if (flow.menuOptions && flow.menuOptions.length > 0) {
                    const menuText = flow.menuOptions.map(option => 
                        `Press ${option.key} for ${option.label}`
                    ).join('. ');
                    updateIvrStatus('Menu Options', menuText);
                    await sleep(5000);
                }

                // Step 4: Enter Queue
                updateIvrStatus('Entering Queue', 'Finding the best agent for your needs...');
                await sleep(2000);

                // Step 5: Start Queue Simulation
                startQueueSimulation();

            } catch (error) {
                console.error('Test IVR Flow Error:', error);
                updateIvrStatus('Error', 'Please try again or contact support.');
            }
        }
    </script>
</body>
</html>
